<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/styles.css">
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
</head>

<body>
    <main>
        <div class="container">
            <div class="text-center mb-5">
                <h1 class="fw-bold mb-0">Harga Tiket Kereta KAI</h1>
                <p class="text-muted fw-bold">Cek Tanggal Keberangkatan Kamu Sekarang</p>
            </div>
            <section class="cari">
                <div class="card">
                    <form id="searchForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="exampleInputPassword1" class="form-label">Stasiun Asal</label>
                                    <select class="form-select origin" id="stasiunAsal" name="orig"
                                        aria-label="Default select example">
                                    </select>
                                    <!-- <input type="text" id="stasiunAsal" name="orig" class="form-control"> -->
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="exampleInputtext1" class="form-label">Stasiun Tujuan</label>
                                    <!-- <input type="text" id="stasiunTujuan" name="dest" class="form-control"> -->
                                    <select class="form-select desc" id="stasiunTujuan" name="dest"
                                        aria-label="Default select example">
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="exampleInputPassword1" class="form-label">Tanggal Berangkat</label>
                                    <input type="date" class="form-control" id="tanggalBerangkat" name="ddate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="exampleInputPassword1" class="form-label">Jumlah Dewasa</label>
                                    <input type="number" min="1" value="1" max="4" class="form-control"
                                        id="exampleInputPassword1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="exampleInputPassword1" class="form-label">Jumlah Anak Anak</label>
                                    <input type="number" min="0" value="0" max="4" class="form-control"
                                        id="exampleInputPassword1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <button class="btn btn-primary btn-cari" type="button" id="cari">Cari Jadwal
                                        Kereta</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <section class="hasil">
                <div class="row" id="result">
                    <!-- <div class="col-md-4">
                        <div class="card">
                            <div class="text-center">
                                <h2>Baturaden Express</h2>
                                <p class="type">Eksekutif (Subclass J)</p>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <small class="code-awal">Purwokerto</small>
                                    <p class="awal">PWT</p>
                                </div>
                                <div class="col-md-4">
                                    <img src="https://www.tiket.com/kereta-api/assets/1b10de97.svg" alt=""
                                        class="train">
                                </div>
                                <div class="col-md-4">
                                    <small class="code-tujuan">Kiara Condong</small>
                                    <p class="tujuan">KAC</p>
                                </div>

                                <div class="col-md-4">
                                    <p class="jam-awal">20.00</p>
                                </div>
                                <div class="col-md-4">
                                    <small class="estimasi">9j 20m</small>
                                </div>
                                <div class="col-md-4">
                                    <p class="jam-tujuan">02:29</p>
                                </div>
                            </div>

                            <div class="row justify-content-between mt-4 mb-0">
                                <div class="col-md-5">
                                    <p class="harga mb-0">Rp 190.000</p>
                                </div>

                                <div class="col-md-6">
                                    <button class="btn btn-outline-info w-100">Tersisa 0 Seat</button>
                                </div>
                            </div>
                        </div>
                    </div> -->
                </div>
            </section>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            const url = "https://booking.kai.id/api/stations2";
            $('.origin').select2({
                theme: 'bootstrap-5',
                ajax: {
                    url: url, // Ganti dengan URL API Anda
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        console.log(params);
                        return {
                            name: params.term
                        };
                    },
                    processResults: function (data) {
                        var results = [];

                        // Ubah format data menjadi sesuai dengan Select2
                        for (var i = 0; i < data.length; i++) {
                            var station = data[i];
                            console.log(station);


                            results.push({
                                id: station.code,
                                text: station.name
                            });
                        }

                        return {
                            results: results
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1
            });
        });

        $(document).ready(function () {
            const url = "https://booking.kai.id/api/stations2";
            $('.desc').select2({
                theme: 'bootstrap-5',
                ajax: {
                    url: url, // Ganti dengan URL API Anda
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        console.log(params);
                        return {
                            name: params.term
                        };
                    },
                    processResults: function (data) {
                        var results = [];

                        // Ubah format data menjadi sesuai dengan Select2
                        for (var i = 0; i < data.length; i++) {
                            var station = data[i];
                            console.log(station);


                            results.push({
                                id: station.code,
                                text: station.name
                            });
                        }

                        return {
                            results: results
                        };
                    },
                    cache: true
                },
                minimumInputLength: 1
            });
        });
    </script>

    <script type="text/javascript">
        $(document).ready(function () {
            $("#cari").click(function () {
                var url = "";
                var tanggal = $('#tanggalBerangkat').val().split("-").join("");
                // var origin = $('#stasiunAsal').find(":selected").val();
                var origin = $('#stasiunAsal').val();
                var dest = $('#stasiunTujuan').val();
                var dewasa = 1;
                var endPoint = `https://www.tiket.com/ms-gateway/tix-train-search-v2/journeys?orig=${origin}&otype=STATION&dest=${dest}&dtype=STATION&ddate=${tanggal}&rdate=&acount=${dewasa}&icount=0&ttype=ONE_WAY`;

                let timerInterval
                Swal.fire({
                    icon: 'info',
                    title: 'Mengambil Jadwal Kereta',
                    html: 'Mohon Tunggu Sebentar',
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: () => {
                        Swal.showLoading()
                        const b = Swal.getHtmlContainer().querySelector('b')
                        timerInterval = setInterval(() => {
                            b.textContent = Swal.getTimerLeft()
                        }, 100)
                    },
                    willClose: () => {
                        clearInterval(timerInterval)
                    }
                }).then((result) => {
                    /* Read more about handling dismissals below */
                    if (result.dismiss === Swal.DismissReason.timer) {
                        getEndPoint(endPoint);
                    }
                })

                function getEndPoint(endPoint) {
                    $.get(endPoint, function (items) {
                        var data = items.data.departJourneys.journeys;
                        // console.log(data);
                        $("#result").empty();
                        if (data.length > 0) {
                            var cardsContainer = $('#cards-container');

                            for (var i = 0; i < data.length; i++) {
                                var journey = data[i];
                                // console.log(journey);
                                var card = createCard(journey);
                                cardsContainer.append(card);
                            }
                        } else {
                            console.log('Data tidak ditemukan.');
                        }
                    }).fail(function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Jadwal Yang Anda Masukan Tidak Sesuai',
                        });
                    });
                }

                function formatDuration(durationInSeconds) {
                    var hours = Math.floor(durationInSeconds / 3600);
                    var minutes = Math.floor((durationInSeconds % 3600) / 60);

                    return hours + ' j ' + minutes + ' m';
                }

                function formatCurrency(price) {
                    // Konversi string menjadi angka
                    const amount = parseInt(price);

                    // Cek apakah input valid (berupa angka)
                    if (!isNaN(amount)) {
                        // Format mata uang IDR dengan memanfaatkan toLocaleString()
                        const formattedAmount = amount.toLocaleString("id-ID", {
                            style: "currency",
                            currency: "IDR",
                            minimumFractionDigits: 0
                        });

                        return formattedAmount;
                    } else {
                        return 'Error';
                    }
                }

                function ubahFormatWaktu(waktu) {
                    const waktuInput = waktu;

                    // Cek apakah format waktu valid (HH:mm:ss)
                    const waktuRegex = /^(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/;
                    if (waktuRegex.test(waktuInput)) {
                        // Ambil bagian jam dan menit dari waktu
                        const jamMenit = waktuInput.slice(0, 5);

                        return jamMenit;
                    } else {
                        return "error";
                    }
                }

                function createCard(journey) {
                    var items = journey.segmentSchedules[0];
                    console.log(items);

                    var kartu = `<div class="col-md-4">
                        <div class="card mb-4">
                            <div class="text-center">
                                <h2>${items.trainName}</h2>
                                <p class="type">${items.wagonClass.detail} ( ${items.subClass.code} )</p>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <small class="code-awal">${items.departureStation.name}</small>
                                    <p class="awal">${items.departureStation.code}</p>
                                </div>
                                <div class="col-md-4">
                                    <img src="https://www.tiket.com/kereta-api/assets/1b10de97.svg" alt=""
                                        class="train">
                                </div>
                                <div class="col-md-4">
                                    <small class="code-tujuan">${items.arrivalStation.name}</small>
                                    <p class="tujuan">${items.arrivalStation.code}</p>
                                </div>

                                <div class="col-md-4">
                                    <p class="jam-awal">${ubahFormatWaktu(items.departureTime)}</p>
                                </div>
                                <div class="col-md-4">
                                    <small class="estimasi">${formatDuration(items.tripDuration)}</small>
                                </div>
                                <div class="col-md-4">
                                    <p class="jam-tujuan">${ubahFormatWaktu(items.arrivalTime)}</p>
                                </div>
                            </div>

                            <div class="row justify-content-between mt-4 mb-0">
                                <div class="col-md-5">
                                    <p class="harga mb-0">${formatCurrency(items.loyaltyReward.baseAmount)}</p>
                                </div>

                                <div class="col-md-6">
                                    <button class="btn ${items.availableSeats == "0" ? 'btn-outline-danger' : 'btn-outline-success'} w-100 fw-bold">Tersisa ${items.availableSeats} Seat</button>
                                </div>
                            </div>
                        </div>
                    </div>`;

                    return $("#result").append(kartu);
                }
            });
        });
    </script>
</body>

</html>